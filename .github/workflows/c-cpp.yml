name: GEMM Benchmark CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-cpu:
    name: Build & Test (CPU)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libeigen3-dev

      - name: Configure (CMake)
        run: |
          mkdir -p build
          cd build
          cmake ..

      - name: Build all targets
        run: |
          cd build
          make -j"$(nproc)"

      - name: List built executables
        run: |
          ls -la build/bench_*

      - name: Run REF benchmark (correctness check)
        run: |
          ./build/bench_ref --m 256 --n 256 --k 256 --iters 3

      - name: Run Blocked benchmark
        run: |
          ./build/bench_blocked --m 256 --n 256 --k 256 --iters 3

      - name: Run AVX2 benchmark
        run: |
          ./build/bench_avx2 --m 256 --n 256 --k 256 --iters 3

      - name: Run AVX2+Blocked benchmark
        run: |
          ./build/bench_avx2_blocked --m 256 --n 256 --k 256 --iters 3

      - name: Run OpenMP benchmark
        run: |
          OMP_NUM_THREADS=2 ./build/bench_openmp --m 256 --n 256 --k 256 --iters 3

      - name: Run AVX2+OpenMP benchmark
        run: |
          OMP_NUM_THREADS=2 ./build/bench_avx2_openmp --m 256 --n 256 --k 256 --iters 3

      - name: Run AVX2+OpenMP+Blocked benchmark
        run: |
          OMP_NUM_THREADS=2 ./build/bench_avx2_openmp_blocked --m 256 --n 256 --k 256 --iters 3

      - name: Run Strassen benchmark
        run: |
          ./build/bench_strassen --m 256 --n 256 --k 256 --iters 2

  build-cuda:
    name: Build (CUDA)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.23
        with:
          cuda: '12.6.0'
          method: 'network'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libeigen3-dev

      - name: Configure with CUDA
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_CUDA_COMPILER=$(which nvcc) \
                -DCUBLAS_LIBRARY=/usr/local/cuda/lib64/libcublas.so ..

      - name: Build all targets (including CUDA)
        run: |
          cd build
          make -j"$(nproc)"

      - name: Verify CUDA binaries built
        run: |
          ls -la build/bench_cuda* build/bench_cublas || echo "Some CUDA binaries not built"